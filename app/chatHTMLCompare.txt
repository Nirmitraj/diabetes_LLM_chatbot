<!DOCTYPE html>

<!--
 // WEBSITE: https://themefisher.com
 // TWITTER: https://twitter.com/themefisher
 // FACEBOOK: https://www.facebook.com/themefisher
 // GITHUB: https://github.com/themefisher/
-->

<html lang="en" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Mono - Responsive Admin & Dashboard Template</title>

 <!-- GOOGLE FONTS -->
 <link href="https://fonts.googleapis.com/css?family=Karla:400,700|Roboto" rel="stylesheet">

 <link href="{{ url_for('static', filename='plugins/material/css/materialdesignicons.min.css') }}" rel="stylesheet" />

 <link href="{{ url_for('static', filename='plugins/simplebar/simplebar.css') }}" rel="stylesheet" />


 <!-- PLUGINS CSS STYLE -->
 <link href="{{ url_for('static', filename='plugins/nprogress/nprogress.css') }}" rel="stylesheet" />




 <link href="{{ url_for('static', filename='plugins/DataTables/DataTables-1.10.18/css/jquery.dataTables.min.css') }}" rel="stylesheet" />



 <link href="{{ url_for('static', filename='plugins/jvectormap/jquery-jvectormap-2.0.3.css') }}" rel="stylesheet" />



 <link href="{{ url_for('static', filename='plugins/daterangepicker/daterangepicker.css') }}" rel="stylesheet" />



 <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">



 <link href="{{ url_for('static', filename='plugins/toaster/toastr.min.css') }}" rel="stylesheet" />


 <!-- MONO CSS -->
 <link id="main-css-href" rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />




 <!-- FAVICON -->
 <link href="{{ url_for('static', filename='images/favicon.png') }}" rel="shortcut icon" />

  <!--
    HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries
  -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <script src="{{ url_for('static', filename='plugins/nprogress/nprogress.js') }}"></script>


</head>


  <body class="navbar-fixed sidebar-fixed" id="body">
    <script>
      NProgress.configure({ showSpinner: false });
      NProgress.start();
    </script>



    <!-- ====================================
    ——— WRAPPER
    ===================================== -->
    <div class="wrapper">


        <!-- ====================================
          ——— LEFT SIDEBAR WITH OUT FOOTER
        ===================================== -->
        <aside class="left-sidebar sidebar-dark" id="left-sidebar">
          <div id="sidebar" class="sidebar sidebar-with-footer">
            <!-- Aplication Brand -->
            <div class="app-brand">
              <a href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}">

              </a>
            </div>
            <!-- begin sidebar scrollbar -->
            <div class="sidebar-left" data-simplebar style="height: 100%;">
              <!-- sidebar menu -->
              <ul class="nav sidebar-inner" id="sidebar-menu">



                  <li
                   class="active"
                   >
                    <a class="sidenav-item-link" href="{{ url_for('main.main_page') }}">
                      <i class="mdi mdi-briefcase-account-outline"></i>
                      <span class="nav-text">Dashboard</span>
                    </a>
                  </li>





                  <!-- <li
                   >
                    <a class="sidenav-item-link" href="analytics.html">
                      <i class="mdi mdi-chart-line"></i>
                      <span class="nav-text">Analytics Dashboard</span>
                    </a>
                  </li> -->


                  <li
                  >
                   <a class="sidenav-item-link" href="{{ url_for('main.getting_started') }}">
                     <i class="mdi mdi-airplane"></i>
                     <span class="nav-text">Getting Started</span>
                   </a>
                 </li>



                  <li class="section-title">
                    Apps
                  </li>



                  <li  class="has-sub" >
                    <a class="sidenav-item-link" href="javascript:void(0)" data-toggle="collapse" data-target="#users"
                      aria-expanded="false" aria-controls="users">
                      <i class="mdi mdi-image-filter-none"></i>
                      <span class="nav-text">User</span> <b class="caret"></b>
                    </a>
                    <ul  class="collapse"  id="users"
                      data-parent="#sidebar-menu">
                      <div class="sub-menu">



                            <li >
                              <a class="sidenav-item-link" href="{{ url_for('main.user_profile') }}">
                                <span class="nav-text">User Profile</span>

                              </a>
                            </li>




                            <li >
                              <a class="sidenav-item-link" href="{{ url_for('main.user_activities') }}">
                                <span class="nav-text">User Activities</span>

                              </a>
                            </li>






                            <li >
                              <a class="sidenav-item-link" href="{{ url_for('main.user_profile_settings') }}">
                                <span class="nav-text">User Profile Settings</span>

                              </a>
                            </li>






                            <li >
                              <a class="sidenav-item-link" href="{{ url_for('main.user_account_settings') }}">
                                <span class="nav-text">User Account Settings</span>

                              </a>
                            </li>





                      </div>
                    </ul>
                  </li>





                  <li
                   >
                    <a class="sidenav-item-link" href="{{ url_for('main.chat') }}">
                      <i class="mdi mdi-wechat"></i>
                      <span class="nav-text">Chat</span>
                    </a>
                  </li>

              </ul>

            </div>

            <div class="sidebar-footer">
              <div class="sidebar-footer-content">
                <ul class="d-flex">
                  <li>
                    <a href="{{ url_for('main.user_account_settings') }}" data-toggle="tooltip" title="Profile settings"><i class="mdi mdi-settings"></i></a></li>
                  <li>
                    <a href="#" data-toggle="tooltip" title="No chat messages"><i class="mdi mdi-chat-processing"></i></a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </aside>



      <!-- ====================================
      ——— PAGE WRAPPER
      ===================================== -->
      <div class="page-wrapper">

          <!-- Header -->
          <header class="main-header" id="header">
            <nav class="navbar navbar-expand-lg navbar-light" id="navbar">
              <!-- Sidebar toggle button -->
              <button id="sidebar-toggler" class="sidebar-toggle">
                <span class="sr-only">Toggle navigation</span>
              </button>

              <span class="page-title">chat</span>

              <div class="navbar-right ">

                <!-- search form -->
                <div class="search-form">
                  <ul class="dropdown-menu dropdown-menu-search">

                    <li class="nav-item">
                      <a class="nav-link" href="{{ url_for('main.main_page') }}">Morbi leo risus</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="{{ url_for('main.main_page') }}">Dapibus ac facilisis in</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="{{ url_for('main.main_page') }}">Porta ac consectetur ac</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="{{ url_for('main.main_page') }}">Vestibulum at eros</a>
                    </li>

                  </ul>

                </div>

                <ul class="nav navbar-nav">
                  <!-- Offcanvas -->

                  <li class="custom-dropdown">
                    <button class="notify-toggler custom-dropdown-toggler">
                      <i class="mdi mdi-bell-outline icon"></i>
                      <span class="badge badge-xs rounded-circle">21</span>
                    </button>
                    <div class="dropdown-notify">

                      <header>
                        <div class="nav nav-underline" id="nav-tab" role="tablist">
                          <a class="nav-item nav-link active" id="all-tabs" data-toggle="tab" href="#all" role="tab" aria-controls="nav-home"
                            aria-selected="true">All (5)</a>
                          <a class="nav-item nav-link" id="message-tab" data-toggle="tab" href="#message" role="tab" aria-controls="nav-profile"
                            aria-selected="false">Msgs (4)</a>
                          <a class="nav-item nav-link" id="other-tab" data-toggle="tab" href="#other" role="tab" aria-controls="nav-contact"
                            aria-selected="false">Others (3)</a>
                        </div>
                      </header>

                      <div class="" data-simplebar style="height: 325px;">
                        <div class="tab-content" id="myTabContent">

                          <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tabs">

                            <div class="media media-sm bg-warning-10 p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user.jpg') }}" alt="User Image">

                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">

                                  <span class="title mb-0">{{ session['user_name'] }}</span>
                                  <span class="discribe">Extremity sweetness difficult behaviour he of. On disposal of as landlord horrible. Afraid at highly months do things on at.</span>
                                  <span class="time">
                                    <time>Just now</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 bg-light mb-0">
                              <div class="media-sm-wrapper bg-primary">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-calendar-check-outline"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">New event added</span>
                                  <span class="discribe">1/3/2014 (1pm - 2pm)</span>
                                  <span class="time">
                                    <time>10 min ago...</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user-sm-03.jpg') }}" alt="User Image">

                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Sagge Hudson</span>
                                  <span class="discribe">On disposal of as landlord Afraid at highly months do things on at.</span>
                                  <span class="time">
                                    <time>1 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper bg-info-dark">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-account-multiple-check"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Add request</span>
                                  <span class="discribe">Add Dany Jones as your contact.</span>
                                  <div class="buttons">
                                    <a href="#" class="btn btn-sm btn-success shadow-none text-white">accept</a>
                                    <a href="#" class="btn btn-sm shadow-none">delete</a>
                                  </div>
                                  <span class="time">
                                    <time>6 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper bg-info">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-playlist-check"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Task complete</span>
                                  <span class="discribe">Afraid at highly months do things on at.</span>
                                  <span class="time">
                                    <time>1 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                          </div>

                          <div class="tab-pane fade" id="message" role="tabpanel" aria-labelledby="message-tab">

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user.jpg') }}" alt="User Image">

                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Selena Wagner</span>
                                  <span class="discribe">Lorem ipsum dolor sit amet, consectetur adipisicing elit.</span>
                                  <span class="time">
                                    <time>15 min ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user.jpg') }}" alt="User Image">

                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Sagge Hudson</span>
                                  <span class="discribe">On disposal of as landlord Afraid at highly months do things on at.</span>
                                  <span class="time">
                                    <time>1 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm bg-warning-10 p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user.jpg') }}" alt="User Image">
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">{{ session['user_name'] }}</span>
                                  <span class="discribe">Extremity sweetness difficult behaviour he of. On disposal of as landlord horrible. Afraid
                                    at highly months do things on at.</span>
                                  <span class="time">
                                    <time>Just now</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <img src="{{ url_for('static', filename='images/user/user.jpg') }}" alt="User Image">
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Albrecht Straub</span>
                                  <span class="discribe"> Beatae quia natus assumenda laboriosam, nisi perferendis aliquid consectetur expedita non tenetur.</span>
                                  <span class="time">
                                    <time>Just now</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                          </div>
                          <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="contact-tab">

                            <div class="media media-sm p-4 bg-light mb-0">
                              <div class="media-sm-wrapper bg-primary">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-calendar-check-outline"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">New event added</span>
                                  <span class="discribe">1/3/2014 (1pm - 2pm)</span>
                                  <span class="time">
                                    <time>10 min ago...</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper bg-info-dark">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-account-multiple-check"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Add request</span>
                                  <span class="discribe">Add Dany Jones as your contact.</span>
                                  <div class="buttons">
                                    <a href="#" class="btn btn-sm btn-success shadow-none text-white">accept</a>
                                    <a href="#" class="btn btn-sm shadow-none">delete</a>
                                  </div>
                                  <span class="time">
                                    <time>6 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                            <div class="media media-sm p-4 mb-0">
                              <div class="media-sm-wrapper bg-info">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <i class="mdi mdi-playlist-check"></i>
                                </a>
                              </div>
                              <div class="media-body">
                                <a href="{{ url_for('main.user_profile') }}">
                                  <span class="title mb-0">Task complete</span>
                                  <span class="discribe">Afraid at highly months do things on at.</span>
                                  <span class="time">
                                    <time>1 hrs ago</time>...
                                  </span>
                                </a>
                              </div>
                            </div>

                          </div>
                        </div>
                      </div>

                      <footer class="border-top dropdown-notify-footer">
                        <div class="d-flex justify-content-between align-items-center py-2 px-4">
                          <span>Last updated 3 min ago</span>
                          <a id="refress-button" href="javascript:" class="btn mdi mdi-cached btn-refress"></a>
                        </div>
                      </footer>
                    </div>
                  </li>
                  <!-- User Account -->
                  <li class="dropdown user-menu">
                    <button class="dropdown-toggle nav-link" data-toggle="dropdown">

                      <img src="{{ url_for('static', filename='images/user/user-xs-01.jpg') }}"
                      class="user-image rounded-circle" alt="User Image" />
                      <span class="d-none d-lg-inline-block">{{ session['user_name'] }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right">
                      <li>
                        <a class="dropdown-link-item" href="{{ url_for('main.user_profile') }}">
                          <i class="mdi mdi-account-outline"></i>
                          <span class="nav-text">My Profile</span>
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-link-item" href="email-inbox.html">
                          <i class="mdi mdi-email-outline"></i>
                          <span class="nav-text">Message</span>
                          <span class="badge badge-pill badge-primary">24</span>
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-link-item" href="{{ url_for('main.user_activities') }}">
                          <i class="mdi mdi-diamond-stone"></i>
                          <span class="nav-text">Activitise</span></a>
                      </li>
                      <li>
                        <a class="dropdown-link-item" href="{{ url_for('main.user_account_settings') }}">
                          <i class="mdi mdi-settings"></i>
                          <span class="nav-text">Account Setting</span>
                        </a>
                      </li>

                      <li class="dropdown-footer">
                        <a class="dropdown-link-item" href="{{ url_for('main.logout') }}"> <i class="mdi mdi-logout"></i> Log Out </a>
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </nav>


          </header>

        <!-- ====================================
        ——— CONTENT WRAPPER
        ===================================== -->
        <div class="content-wrapper">
          <div class="content"><div class="row no-gutters">
  <div class="col-lg-5 col-xxl-4">
    <div class="card card-default chat-left-sidebar">
      <form class="card-header px-0">
        <div class="input-group px-5">
          <!-- <a href=""><md-button class="md-fab md-mini mdi mdi-pencil-box-outline mdi-24px p-2"> </md-button></a> -->
          <button type="button" id= "new-chat" class="mb-1 btn btn-pill btn-success mb-2 btn-sm">New Chat</button>

        </div>
        <div class="input-group px-5">
          <input type="text" class="form-control" aria-label="Text input with dropdown button" placeholder="Search...">

        </div>
      </form>
      <ul class="card-body px-0" id="chat-history-container" data-simplebar style="height: 630px;">
      <!-- space for chat history containers -->
      </ul>
    </div>
  </div>

  <div class="col-lg-7 col-xxl-8">
    <!-- Chat -->
    <div class="card card-default chat-right-sidebar">
      <div class="card-header">
        <h2>Chat</h2>

        </div>

      <div class="card-body pb-0" data-simplebar style="height: 545px;">

      <div class="card-body pb-0" id="chat-container" data-simplebar style="height: 545px;">
        <!-- Existing messages will go here -->
      </div>

      <div class="chat-footer">
        <form id="chat-form">
          <div class="input-group-chat">
            <input type="text" id="user-message" class="form-control" placeholder="Type a message..." />
            <button type="button" id="send-button" class="btn btn-info">Send</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</div>

        </div>

          <!-- Footer -->
          <footer class="footer mt-auto">

            <!-- <script>
                var d = new Date();
                var year = d.getFullYear();
                document.getElementById("copy-year").innerHTML = year;
            </script> -->

            <script>
let chatHistory = [];
let currentChatMessages = [];

document.addEventListener('DOMContentLoaded', function () {
  const token = localStorage.getItem('access_token');

  if (token) {
    fetch('/get-chat-history', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    })
      .then(response => {
        if (!response.ok) {
          console.error('Failed to fetch chat history:', response.statusText);
          return;
        }
        return response.json();
      })
      .then(data => {
        if (data.chat_history) {
          console.log('Chat history received:', data.chat_history);

          // Populate chat history cards in the UI
          data.chat_history.forEach((chat, index) => {
            chatHistory.push(chat.messages); // Add to chatHistory array
            addChatHistCardToUI(index); // Add chat card to the UI
          });
        }
      })
      .catch(error => console.error('Error fetching chat history:', error));
  }
});

document.getElementById('new-chat').addEventListener('click', function () {
  if (currentChatMessages.length > 0) {
    // Prepare the current messages for the backend
    const token = localStorage.getItem('access_token');
    fetch('/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }), // Include token if available
      },
      body: JSON.stringify({
        new_chat: true,
        messages: currentChatMessages, // Send all messages in the current conversation
      }),
    })
      .then((response) => {
        if (!response.ok) {
          console.error('Failed to send current chat messages to backend:', response.statusText);
        }
      })
      .catch((error) => {
        console.error('Error sending current chat messages to backend:', error);
      });

    // Add current chat messages to chat history
    chatHistory.push([...currentChatMessages]); // Store a copy of the current messages

    // Update chat history UI
    addChatHistCardToUI(chatHistory.length - 1);

    // Clear current chat messages
    currentChatMessages = [];
  }

  // Clear chat container for a new conversation
  const chatContainer = document.getElementById('chat-container');
  chatContainer.innerHTML = '';
  event.preventDefault();
});

document.getElementById('send-button').addEventListener('click', function () {
  console.log("send button clicked")
  const messageInput = document.getElementById('user-message');
  const userMessage = messageInput.value.trim();

  const token = localStorage.getItem('access_token'); // Retrieve the token from localStorage

  if (userMessage && token) {
    // Add the user message to the current chat UI
    addMessageToUI(userMessage, true); // Display user message immediately
    currentChatMessages.push({ content: userMessage, isUser: true }); // Save message to current chat
    messageInput.value = ''; // Clear input field

    // Send message to the backend to save and get a response
    fetch('/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ query: userMessage }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.response) {
          // Display the assistant's response
          addMessageToUI(data.response, false); // Add response to UI
          currentChatMessages.push({ content: data.response, isUser: false }); // Save response to chat

          // If this is a new chat, update the chat history sidebar
          if (currentChatMessages.length === 1) {
            chatHistory.push([...currentChatMessages]); // Save the full conversation
            addChatHistCardToUI(chatHistory.length - 1); // Add to the sidebar
            currentChatMessages = []; // Clear current chat messages
          }
        } else {
          console.error('Error:', data.message);
        }
      })
      .catch(error => console.error('Error:', error));
  }
});

async function addChatHistCardToUI(chatIndex, isUser = true) {
  const chatHistContainer = document.getElementById('chat-history-container');
  const lastMessagePreview = chatHistory[chatIndex][chatHistory[chatIndex].length - 1].content;
  const firstUserMessage = chatHistory[chatIndex][0].content;
  const newChatHist = document.createElement('li');
  newChatHist.className = 'chat-history-item';

  let chatTitle = 'New Chat'; // Default title

  const token = localStorage.getItem('access_token');
  if (token) {
    try {
      // Fetch the chat title from the server
      const response = await fetch('/chat_title', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` }), // Include token if available
        },
        body: JSON.stringify({ query: firstUserMessage }),
      });

      const data = await response.json();

      if (data.response) {
        chatTitle = data.response; // Update the chat title
        console.log('Chat title received:', chatTitle);
      } else {
        console.error('Error fetching chat title:', data.message);
      }
    } catch (error) {
      console.error('Error fetching chat title:', error);
    }
  }

  newChatHist.innerHTML = `
    <div class="media media-message">
      <div class="position-relative mr-3">
        <img class="rounded-circle" src="{{ url_for('static', filename='images/user/bot.jpg') }}" alt="User Image">
        <span class="status active"></span>
      </div>
      <div class="media-body">
        <div class="message-contents">
          <span class="d-flex justify-content-between align-items-center mb-1">
            <button data-chat-id="${chatIndex}" class="username text-dark">${chatTitle}</button>
            <div class="my-dropdown">
              <button class="my-dropdown-btn" data-chat-id="${chatIndex}">
                <svg width="12" height="12" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12ZM10 12C10 10.8954 10 12 12 12C13.1046 12 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 12 10 12ZM17 12C17 10.8954 17.8954 10 19 10C20.1046 10 21 10.8954 21 12C21 13.1046 20.1046 14 19 14C17.8954 14 17 13.1046 17 12Z"
                    fill="currentColor"></path>
                </svg>
              </button>
              <div class="my-dropdown-content">
                <div class="my-dropdown-item">Delete Chat <span class="mdi mdi-delete" style="color: rgb(177, 42, 42);"></span></div>
                <div class="my-dropdown-item">Rename <span class="mdi mdi-square-edit-outline"></span></div>
              </div>
            </div>
          </span>
          <p class="last-msg text-smoke">${lastMessagePreview}</p>
        </div>
      </div>
    </div>
  `;

  console.log(`Adding chat history item for Chat ${chatIndex + 1} with data-chat-id=${chatIndex}`);

  chatHistContainer.prepend(newChatHist);
}

// Use event delegation to handle clicks on all dropdown items
document.getElementById('chat-history-container').addEventListener('click', function(event) {
    console.log('Clicked element:', event.target);

    // Handle clicks on chat-history-item
    const chatItem = event.target.closest('.chat-history-item');
    console.log('Closest chat-history-item:', chatItem);
    if (chatItem) {
        const usernameButton = event.target.closest('.username');
        if (usernameButton) {
            const chatId = usernameButton.getAttribute('data-chat-id');
            console.log(`Chat item clicked: ${chatId}`);
            // Handle chat item selection logic here
            return;
        }
    }

    // Handle clicks on dropdown items
    const dropdownItem = event.target.closest('.my-dropdown-item');
    if (dropdownItem) {
        const action = dropdownItem.textContent.trim();
        const chatId = parseInt(dropdownItem.closest('.my-dropdown').querySelector('.my-dropdown-btn').getAttribute('data-chat-id'), 10);

        if (action === 'Delete Chat') {
          console.log('Clicked element:', event.target);
            console.log(`Deleting chat ${chatId}`);
            // Delete chat from chatHistory array
            chatHistory.splice(chatId, 1);

            // Rebuild the chat history UI
            rebuildChatHistoryUI();

            // Clear the current chat if it's the deleted one
            if (chatId === currentChatIndex) {
                document.getElementById('chat-container').innerHTML = '';
                currentChatMessages = [];
            }
        } else if (action === 'Rename') {
          console.log('Clicked element:', event.target);
            console.log(`Renaming chat ${chatId}`);
            // Prompt the user for a new name
            const newChatName = prompt("Enter a new name for this chat:", `Chat ${chatId + 1}`);
            if (newChatName) {
                // Update the chat history UI with the new name
                const usernameButton = document.querySelector(`button[data-chat-id="${chatId}"]`);
                if (usernameButton) {
                    usernameButton.textContent = newChatName;
                }
            }
        }
        return;
    }
});

/**
 * Rebuild the chat history UI to reflect updated chatHistory array.
 */
 function rebuildChatHistoryUI() {
    const chatHistContainer = document.getElementById('chat-history-container');
    chatHistContainer.innerHTML = ''; // Clear the container

    chatHistory.forEach((chat, index) => {
        addChatHistCardToUI(index); // Add each chat back to the UI
    });
}


// Function to add a new message to the chat container
document.getElementById('send-button').addEventListener('click', function () {
  console.log("clicked element: ", event.target);
  const messageInput = document.getElementById('user-message');
  const userMessage = messageInput.value.trim();

  if (userMessage) {
    addMessageToUI(userMessage, true); // Display user message immediately
    currentChatMessages.push({ content: userMessage, isUser: true }); // Save message to current chat
    messageInput.value = ''; // Clear input

    // Send message to server (if needed for backend response)
    $.ajax({
      type: 'POST',
      url: '/chat', // Ensure this endpoint is defined in your Flask app
      contentType: 'application/json',
      data: JSON.stringify({ query: userMessage }),
      success: function (response) {
        if (response && response.response) {
          addMessageToUI(response.response, false); // Display bot response
          currentChatMessages.push({ content: response.response, isUser: false }); // Save bot response to current chat
        }
      },
      error: function () {
        addMessageToUI('Error: Could not get response.', false);
        currentChatMessages.push({ content: 'Error: Could not get response.', isUser: false }); // Save error to current chat
      }
    });
  }
});

// Function to append a message to the UI
function addMessageToUI(content, isUser = true) {
  const chatContainer = document.getElementById('chat-container');
  const messageDiv = document.createElement('div');
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  messageDiv.className = isUser ? 'media media-chat media-chat-right' : 'media media-chat';
  messageDiv.innerHTML = `
    <div class="media-body">
      <div class="text-content">
        <span class="message">${content}</span>
        <time class="time">${timestamp}</time>
      </div>
    </div>
  `;

  if (isUser) {
    messageDiv.innerHTML += `<img src="{{ url_for('static', filename='images/user/user.jpg') }}" class="rounded-circle" alt="User Image">`;
  } else {
    messageDiv.innerHTML = `<img src="{{ url_for('static', filename='images/user/bot.jpg') }}" class="rounded-circle" alt="Bot Image">` + messageDiv.innerHTML;
  }

  chatContainer.appendChild(messageDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to the bottom
}

document.getElementById('chat-history-container').addEventListener('click', function(event) {
  // Check if the clicked element is a button with the `username` class
  console.log("event target: ",event.target,"   clicked")
  if (event.target && event.target.classList.contains('username')) {
    // Get the chat ID from the button's `data-chat-id` attribute
    const chatId = event.target.getAttribute('data-chat-id');

    if (chatId !== null) {
      console.log(`Event delegation: Loading chat history for Chat ${parseInt(chatId) + 1}`);
      loadChatFromHistory(parseInt(chatId));
    }
  }
});

function loadChatFromHistory(chatIndex) {
  console.log(`Loading chat history for Chat ${chatIndex + 1}`);
  const chatContainer = document.getElementById('chat-container');
  chatContainer.innerHTML = ''; // Clear current chat messages

  // Load each message from the selected chat history
  chatHistory[chatIndex].forEach((msg) => {
    addMessageToUI(msg.content, msg.isUser);
  });
}

  </script>
          </footer>

      </div>
    </div>

                    <!-- Card Offcanvas -->
                    <div class="card card-offcanvas" id="contact-off" >
                      <div class="card-header">
                        <h2>Contacts</h2>
                        <a href="#" class="btn btn-primary btn-pill px-4">Add New</a>
                      </div>
                      <div class="card-body">

                        <div class="mb-4">
                          <input type="text" class="form-control form-control-lg form-control-secondary rounded-0" placeholder="Search contacts...">
                        </div>

                    <script src="{{ url_for('static', filename='plugins/jquery/jquery.min.js') }}"></script>

                    <script src="{{ url_for('static', filename='plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

                    <script src="{{ url_for('static', filename='plugins/simplebar/simplebar.min.js') }}"></script>

                    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>

                    <script src="{{ url_for('static', filename='plugins/apexcharts/apexcharts.js') }}"></script>

                    <script src="{{ url_for('static', filename='plugins/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js') }}"></script>



                    <script src="{{ url_for('static', filename='plugins/jvectormap/jquery-jvectormap-2.0.3.min.js') }}"></script>

                    <script src="{{ url_for('static', filename='plugins/jvectormap/jquery-jvectormap-world-mill.js') }}"></script>

                    <script src="{{ url_for('static', filename='plugins/jvectormap/jquery-jvectormap-us-aea.js') }}"></script>


                    <script src="{{ url_for('static', filename='plugins/daterangepicker/moment.min.js') }}"></script>
                    <script src="{{ url_for('static', filename='plugins/daterangepicker/daterangepicker.js') }}"></script>

                    <script>
                      jQuery(document).ready(function() {
                        jQuery('input[name="dateRange"]').daterangepicker({
                        autoUpdateInput: false,
                        singleDatePicker: true,
                        locale: {
                          cancelLabel: 'Clear'
                        }
                      });
                        jQuery('input[name="dateRange"]').on('apply.daterangepicker', function (ev, picker) {
                          jQuery(this).val(picker.startDate.format('MM/DD/YYYY'));
                        });
                        jQuery('input[name="dateRange"]').on('cancel.daterangepicker', function (ev, picker) {
                          jQuery(this).val('');
                        });
                      });
                    </script>



                    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>



                    <script src="{{ url_for('static', filename='plugins/toaster/toastr.min.js') }}"></script>



                    <script src="{{ url_for('static', filename='js/mono.js') }}"></script>
                    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
                    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
                    <script src="{{ url_for('static', filename='js/custom.js') }}"></script>




                    <!--  -->


  </body>
</html>